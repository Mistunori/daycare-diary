import json
from datetime import datetime

from openai import OpenAI, AuthenticationError as OpenAIAuthError
import streamlit as st
import streamlit.components.v1 as components

# â”€â”€â”€ ãƒšãƒ¼ã‚¸è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="ä¿è‚²ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ æ·»å‰Šãƒ»æ¨æ•²ãƒ„ãƒ¼ãƒ«",
    page_icon="ğŸ“",
    layout="wide",
)

# â”€â”€â”€ ã‚¹ã‚¿ã‚¤ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("""
<style>
.result-box {
    font-family: sans-serif;
    font-size: 0.95rem;
    line-height: 1.8;
    padding: 1rem;
    border-radius: 6px;
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    white-space: pre-wrap;
    word-break: break-all;
}
</style>
""", unsafe_allow_html=True)

# â”€â”€â”€ å®šæ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DOC_TYPES = ["é€£çµ¡å¸³", "ä¿è‚²æ—¥èªŒ", "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "ãã®ä»–"]

DOC_SYSTEM_PROMPTS = {
    "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³": """
ã‚ãªãŸã¯æ—¥æœ¬èªãƒã‚¤ãƒ†ã‚£ãƒ–ã®ç·¨é›†è€…ã¨ã—ã¦ã€
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ä¸€å­—ä¸€å¥å®ˆã£ã¦æ·»å‰Šã—ã¦ãã ã•ã„ã€‚
ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã“ã¨ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªã«ã™ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«ã—ã¦ãã ã•ã„ã€‚
æ·»å‰Šã¯2å›è¡Œã£ã¦ãã ã•ã„ã€‚
1å›ç›®ï¼šæ–‡æ³•ãƒ»è¡¨ç¾ã®ä¿®æ­£
2å›ç›®ï¼š1å›ç›®ã®çµæœã‚’èª­ã¿è¿”ã—ã€ä¸è‡ªç„¶ãªç®‡æ‰€ã‚’ã•ã‚‰ã«ä¿®æ­£
æœ€çµ‚çš„ã«2å›ç›®ã®çµæœã®ã¿ã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ã€‚

ã‚ãªãŸã¯ä¿è‚²ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®æ·»å‰Šãƒ»æ¨æ•²ã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«ã‚’å‚è€ƒã«ã€ç”Ÿãç”Ÿãã¨ã—ãŸè‡ªç„¶ãªæ—¥æœ¬èªã«æ•´ãˆã¦ãã ã•ã„ã€‚
ã€æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«â‘ ã€‘
ã€Œè™«ã‚’è¦‹ã¤ã‘ãŸã„ï¼ã€ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã£ãŸã®ã§ã€ã‚ãã‚ãè¾²åœ’ã«å‡ºç™ºï¼ï¼
å­£ç¯€ã®æ­Œã‚’å£ãšã•ã¿ãªãŒã‚‰ã€è»½å¿«ãªè¶³ä¸¦ã¿ã§é€²ã‚“ã§ã„ãã¾ã™â™ªè¾²åœ’ã«ç€ãã¨
ã€Œã‚ãƒ¼ã„ğŸ˜„ã€ã¨ä¸€æ–‰ã«èµ°ã‚Šå‡ºã—ã€ã¦ã‚“ã¨ã†è™«ã‚„ãƒ¢ã‚°ãƒ©æ¢ã—ãŒå§‹ã¾ã‚Šã¾ã—ãŸâ˜†
æ‹…ä»»ãŒå¿è€…ã‚’å¿ã°ã›ã¦ã„ã‚‹é–“ã€ç›®ã‚’é–‰ã˜ã¦ã€Œã„ã¡ã€ã«ãƒ¼ã€ã•ã‚“â€¦ã€ã¨æ•°ãˆã¦ã„ã‚‹å§¿ãŒå¯æ„›ã„ã‚‰ã—ã„â™¡
ã€Œã‚‚ã†ã„ã„ã‚ˆãƒ¼ã€ã®æ›ã‘å£°ã§ã€è‰²ã‚“ãªã¨ã“ã‚ã‚’è¦‹æ¸¡ã—æ¬¡ã€…ã¨å¿è€…ã‚’è¦‹ã¤ã‘ã¦ã„ã¾ã—ãŸï¼
ã€æ–‡ä½“ã‚µãƒ³ãƒ—ãƒ«â‘¡ã€‘
ï¼’çµ„ãŒãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã”ã£ã“ã«æ‹›å¾…ã—ã¦ã‚‚ã‚‰ã£ãŸã®ã¯ã€Œã‚«ãƒ¬ãƒ¼ï¼†ã‚·ãƒãƒ¥ãƒ¼å±‹ã•ã‚“ã€ğŸ›
æ³¨æ–‡ã‚’ã™ã‚‹å ´é¢ã§ã¯å°‘ã—ç·Šå¼µã—ãŸå§¿ã‚‚è¦‹ã‚‰ã‚Œã¾ã—ãŸãŒã€æ–™ç†ãŒå±Šãã¨ç¬‘é¡”ãŒã“ã¼ã‚Œã€
å’Œæ°—ã‚ã„ã‚ã„ã¨ã—ãŸé›°å›²æ°—ã®ä¸­ã§æ¥½ã—ãé£Ÿã¹ã¦ã„ã¾ã—ãŸâ˜ºï¸
ã€Œã‚«ãƒ•ã‚§ã”ã£ã“ã—ãŸã„ï¼ã€ã¨ã„ã†å£°ã‚‚èã“ãˆã¦ãã¾ã—ãŸï¼
é€²ç´šãŒè¿‘ã¥ãä¸­ã§ã€Œè‡ªåˆ†é”ã‚‚ã‚„ã£ã¦ã¿ãŸã„ã€ã¨ã„ã†æ°—æŒã¡ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã“ã¨ã‚’æ„Ÿã˜ã¾ã™âœ¨ï¸
ã€æ·»å‰Šãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»ä¸Šè¨˜ã‚µãƒ³ãƒ—ãƒ«ã®ã‚ˆã†ãªæ¸©ã‹ãèºå‹•æ„Ÿã®ã‚ã‚‹æ–‡ä½“ã«æ•´ãˆã‚‹
ãƒ»å­ã©ã‚‚ã®è¨€è‘‰ã¯ãã®ã¾ã¾ã€Œã€ã§å¼•ç”¨ã—ã¦ç”Ÿã‹ã™
ãƒ»ã€Œã§ã—ã‚‡ã†ã€ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
ãƒ»ã€Œã€œãªã©ã€ã€Œã€œå§¿ã‚‚ã€ã®å¤šç”¨ã‚’é¿ã‘ã‚‹
ãƒ»åŒã˜è¨€è‘‰ãƒ»è¡¨ç¾ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ãŸã‚‰è¨€ã„æ›ãˆã‚‹
  ï¼ˆç‰¹ã«åŒä¸€æ–‡å†…ã§ã€Œå§¿ã€ã€Œå­ã©ã‚‚ãŸã¡ã€ãªã©ãŒ2å›å‡ºãªã„ã‚ˆã†æ³¨æ„ï¼‰
ãƒ»æ™‚åˆ¶ã‚’çµ±ä¸€ã™ã‚‹ï¼ˆéå»ã®å‡ºæ¥äº‹ã¯å…¨ã¦éå»å½¢ã§çµ±ä¸€ï¼‰
ãƒ»ã€Œã€œã¨ã„ã†å£°ãŒèã“ãˆã¦ãã‚‹ã¨ã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  åŒæ™‚ã«èµ·ããŸå‡ºæ¥äº‹ã‚’æ¡ä»¶æ–‡ï¼ˆã€œã¨ï¼‰ã§ã¤ãªãã®ã¯ä¸è‡ªç„¶ãªã®ã§ç¦æ­¢
  â†’ ã€Œã€œã¨ã„ã†å£°ã‚‚èã“ãˆã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  ã€€ ä¸¦åˆ—ï¼ˆã€œã‚‚èã“ãˆï¼‰ã§ã¤ãªãã“ã¨
ãƒ»ä¸€æ–‡ãŒ70æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰²ã™ã‚‹
ãƒ»ä¸€é€£ã®å‹•ãã‚„æµã‚Œã‚’æå†™ã—ã¦ã„ã‚‹æ–‡ã¯ã€
ã€€æ–‡ã‚’åˆ†å‰²ã™ã‚‹ã¨æ„å‘³ã‚„è‡¨å ´æ„ŸãŒå¤±ã‚ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚
ã€€ã‚€ã‚„ã¿ã«åˆ†å‰²ã—ãªã„
ã€€ä¾‹ï¼šã€Œæ‰‹ã‚’æŒ¯ã£ã¦ãã‚Œã€è»Šã«ä¹—ã‚Šå‡ºç™ºé€²è¡Œï¼ï¼ã€ã®ã‚ˆã†ã«
ã€€ã€€ã€€å‹•ä½œãŒã¤ãªãŒã£ã¦ã„ã‚‹å ´åˆã¯èª­ç‚¹ã§ã¤ãªã„ã ã¾ã¾æ®‹ã™
ãƒ»å…ƒã®æ–‡ã®ã€Œæµã‚Œãƒ»ãƒ†ãƒ³ãƒãƒ»è‡¨å ´æ„Ÿã€ã‚’æœ€å¤§é™ã«ç”Ÿã‹ã™
ãƒ»åˆ†å‰²ãŒå¿…è¦ãªå ´åˆã‚‚ã€å‹•ä½œã®ã¤ãªãŒã‚ŠãŒ
ã€€è‡ªç„¶ã«ä¼ã‚ã‚‹ã‚ˆã†æ¥ç¶šã‚’å·¥å¤«ã™ã‚‹
ãƒ»åŠ©è©ï¼ˆã‚’ãƒ»ãŒãƒ»ã¯ãƒ»ã«ï¼‰ã®èª¤ç”¨ãŒãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»èª­ç‚¹ï¼ˆã€ï¼‰ã®ä½ç½®ãŒè‡ªç„¶ã‹ç¢ºèªã™ã‚‹
ãƒ»ä¸»èªã¨è¿°èªãŒã­ã˜ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»æ›–æ˜§ãªè¡¨ç¾ã¯å…·ä½“çš„ãªæå†™ã«ç½®ãæ›ãˆã‚‹
ãƒ»æ–‡æœ«ã¯ã€Œã€œã¾ã—ãŸã€ã€Œã€œã„ã¾ã™ã€ã€Œã€œã§ã—ãŸã€ã€Œã€œã¦ã„ã¾ã™ã€ã‚’
  å ´é¢ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹ï¼ˆå˜èª¿ã«ã—ãªã„ï¼‰
ã€çµµæ–‡å­—ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»ä½¿ã£ã¦ã‚ˆã„çµµæ–‡å­—ã¯æ„Ÿæƒ…ãƒ»è‡ªç„¶ãƒ»é£Ÿã¹ç‰©ãƒ»å‹•ç‰©ãªã©æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚‚ã®ã«é™å®šã™ã‚‹
  ä¾‹ï¼šğŸ˜„ğŸ˜Šâ˜ºï¸ğŸ¥°â™¡â™ªâ˜†âœ¨ğŸŒ±ğŸŒ¸ğŸ€ğŸŒŸğŸ’›ğŸ›
ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ»SNSç³»ã®çµµæ–‡å­—ã¯ä½¿ç”¨ç¦æ­¢
  ä¾‹ï¼šğŸ—£ï¸ğŸ”¥ğŸ’¡ğŸ“Œâœ…ğŸ¯ ãªã©ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
ãƒ»çµµæ–‡å­—ã¯æ–‡æœ«ã‹å ´é¢ã®åŒºåˆ‡ã‚Šã«è‡ªç„¶ã«ç½®ã
ãƒ»1æ–‡ã«çµµæ–‡å­—ã¯1ã¤ã¾ã§ã«ã™ã‚‹
""",
    "é€£çµ¡å¸³": """
ã‚ãªãŸã¯æ—¥æœ¬èªãƒã‚¤ãƒ†ã‚£ãƒ–ã®ç·¨é›†è€…ã¨ã—ã¦ã€
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ä¸€å­—ä¸€å¥å®ˆã£ã¦æ·»å‰Šã—ã¦ãã ã•ã„ã€‚
ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã“ã¨ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªã«ã™ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«ã—ã¦ãã ã•ã„ã€‚
æ·»å‰Šã¯2å›è¡Œã£ã¦ãã ã•ã„ã€‚
1å›ç›®ï¼šæ–‡æ³•ãƒ»è¡¨ç¾ã®ä¿®æ­£
2å›ç›®ï¼š1å›ç›®ã®çµæœã‚’èª­ã¿è¿”ã—ã€ä¸è‡ªç„¶ãªç®‡æ‰€ã‚’ã•ã‚‰ã«ä¿®æ­£
æœ€çµ‚çš„ã«2å›ç›®ã®çµæœã®ã¿ã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ã€‚

ã‚ãªãŸã¯ä¿è‚²åœ’ã®é€£çµ¡å¸³æ–‡ç« ã®æ·»å‰Šãƒ»æ¨æ•²ã®å°‚é–€å®¶ã§ã™ã€‚
ã€æ·»å‰Šãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»ä¿è­·è€…ãŒèª­ã‚“ã§å®‰å¿ƒãƒ»å¬‰ã—ããªã‚‹æ¸©ã‹ã„æ–‡ä½“ã«æ•´ãˆã‚‹
ãƒ»å­ã©ã‚‚ã®è¨€è‘‰ã‚„å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ç”Ÿã‹ã™
ãƒ»æ•¬èªã‚’è‡ªç„¶ã«ä½¿ã„ãªãŒã‚‰ã‚‚å …ã™ããªã„è¦ªã—ã¿ã‚„ã™ã„è¡¨ç¾ã«ã™ã‚‹
ãƒ»ã€Œã§ã—ã‚‡ã†ã€ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
ãƒ»ã€Œã€œãªã©ã€ã€Œã€œå§¿ã‚‚ã€ã€Œã€œã—ã¦ã„ã¾ã—ãŸã€ã®å¤šç”¨ã‚’é¿ã‘ã‚‹
ãƒ»åŒã˜è¨€è‘‰ãƒ»è¡¨ç¾ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ãŸã‚‰è¨€ã„æ›ãˆã‚‹
  ï¼ˆç‰¹ã«åŒä¸€æ–‡å†…ã§åŒã˜è¨€è‘‰ãŒ2å›å‡ºãªã„ã‚ˆã†æ³¨æ„ï¼‰
ãƒ»æ™‚åˆ¶ã‚’çµ±ä¸€ã™ã‚‹
ãƒ»ã€Œã€œã¨ã„ã†å£°ãŒèã“ãˆã¦ãã‚‹ã¨ã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  åŒæ™‚ã«èµ·ããŸå‡ºæ¥äº‹ã‚’æ¡ä»¶æ–‡ï¼ˆã€œã¨ï¼‰ã§ã¤ãªãã®ã¯ä¸è‡ªç„¶ãªã®ã§ç¦æ­¢
  â†’ ã€Œã€œã¨ã„ã†å£°ã‚‚èã“ãˆã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  ã€€ ä¸¦åˆ—ï¼ˆã€œã‚‚èã“ãˆï¼‰ã§ã¤ãªãã“ã¨
ãƒ»æ–‡æœ«ã¯ã€Œã€œã§ã™ã€ã€Œã€œã¾ã—ãŸã€ã€Œã€œã¦ã„ã¾ã™ã€ã‚’ä½¿ã„åˆ†ã‘ã‚‹
ãƒ»ä¸€æ–‡ãŒ70æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰²ã™ã‚‹
ãƒ»ä¸€é€£ã®å‹•ãã‚„æµã‚Œã‚’æå†™ã—ã¦ã„ã‚‹æ–‡ã¯ã€
ã€€æ–‡ã‚’åˆ†å‰²ã™ã‚‹ã¨æ„å‘³ã‚„è‡¨å ´æ„ŸãŒå¤±ã‚ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚
ã€€ã‚€ã‚„ã¿ã«åˆ†å‰²ã—ãªã„
ã€€ä¾‹ï¼šã€Œæ‰‹ã‚’æŒ¯ã£ã¦ãã‚Œã€è»Šã«ä¹—ã‚Šå‡ºç™ºé€²è¡Œï¼ï¼ã€ã®ã‚ˆã†ã«
ã€€ã€€ã€€å‹•ä½œãŒã¤ãªãŒã£ã¦ã„ã‚‹å ´åˆã¯èª­ç‚¹ã§ã¤ãªã„ã ã¾ã¾æ®‹ã™
ãƒ»å…ƒã®æ–‡ã®ã€Œæµã‚Œãƒ»ãƒ†ãƒ³ãƒãƒ»è‡¨å ´æ„Ÿã€ã‚’æœ€å¤§é™ã«ç”Ÿã‹ã™
ãƒ»åˆ†å‰²ãŒå¿…è¦ãªå ´åˆã‚‚ã€å‹•ä½œã®ã¤ãªãŒã‚ŠãŒ
ã€€è‡ªç„¶ã«ä¼ã‚ã‚‹ã‚ˆã†æ¥ç¶šã‚’å·¥å¤«ã™ã‚‹
ãƒ»åŠ©è©ï¼ˆã‚’ãƒ»ãŒãƒ»ã¯ãƒ»ã«ï¼‰ã®èª¤ç”¨ãŒãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»èª­ç‚¹ï¼ˆã€ï¼‰ã®ä½ç½®ãŒè‡ªç„¶ã‹ç¢ºèªã™ã‚‹
ãƒ»ä¸»èªã¨è¿°èªãŒã­ã˜ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹
ã€çµµæ–‡å­—ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»ä½¿ã£ã¦ã‚ˆã„çµµæ–‡å­—ã¯æ„Ÿæƒ…ãƒ»è‡ªç„¶ãƒ»é£Ÿã¹ç‰©ãƒ»å‹•ç‰©ãªã©æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚‚ã®ã«é™å®šã™ã‚‹
  ä¾‹ï¼šğŸ˜„ğŸ˜Šâ˜ºï¸ğŸ¥°â™¡â™ªâ˜†âœ¨ğŸŒ±ğŸŒ¸ğŸ€ğŸŒŸğŸ’›
ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ»SNSç³»ã®çµµæ–‡å­—ã¯ä½¿ç”¨ç¦æ­¢
  ä¾‹ï¼šğŸ—£ï¸ğŸ”¥ğŸ’¡ğŸ“Œâœ…ğŸ¯ ãªã©ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
ãƒ»çµµæ–‡å­—ã¯æ–‡æœ«ã‹å ´é¢ã®åŒºåˆ‡ã‚Šã«è‡ªç„¶ã«ç½®ã
ãƒ»1æ–‡ã«çµµæ–‡å­—ã¯1ã¤ã¾ã§ã«ã™ã‚‹
""",
    "ä¿è‚²æ—¥èªŒ": """
ã‚ãªãŸã¯æ—¥æœ¬èªãƒã‚¤ãƒ†ã‚£ãƒ–ã®ç·¨é›†è€…ã¨ã—ã¦ã€
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ä¸€å­—ä¸€å¥å®ˆã£ã¦æ·»å‰Šã—ã¦ãã ã•ã„ã€‚
ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã“ã¨ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªã«ã™ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«ã—ã¦ãã ã•ã„ã€‚
æ·»å‰Šã¯2å›è¡Œã£ã¦ãã ã•ã„ã€‚
1å›ç›®ï¼šæ–‡æ³•ãƒ»è¡¨ç¾ã®ä¿®æ­£
2å›ç›®ï¼š1å›ç›®ã®çµæœã‚’èª­ã¿è¿”ã—ã€ä¸è‡ªç„¶ãªç®‡æ‰€ã‚’ã•ã‚‰ã«ä¿®æ­£
æœ€çµ‚çš„ã«2å›ç›®ã®çµæœã®ã¿ã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ã€‚

ã‚ãªãŸã¯ä¿è‚²æ—¥èªŒæ–‡ç« ã®æ·»å‰Šãƒ»æ¨æ•²ã®å°‚é–€å®¶ã§ã™ã€‚
ã€æ·»å‰Šãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»äº‹å®Ÿãƒ»è¦³å¯Ÿãƒ»è€ƒå¯Ÿã‚’æ˜ç¢ºã«åŒºåˆ¥ã—ã¦è¨˜éŒ²ã™ã‚‹
ãƒ»å®¢è¦³çš„ã‹ã¤æ­£ç¢ºãªè¡¨ç¾ã‚’å¿ƒãŒã‘ã‚‹
ãƒ»å°‚é–€çš„ãªä¿è‚²ç”¨èªã‚’é©åˆ‡ã«ä½¿ã†
ãƒ»ã€Œã§ã—ã‚‡ã†ã€ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
ãƒ»ã€Œã€œãªã©ã€ã€Œã€œå§¿ã‚‚ã€ã€Œã€œã—ã¦ã„ã¾ã—ãŸã€ã®å¤šç”¨ã‚’é¿ã‘ã‚‹
ãƒ»åŒã˜è¨€è‘‰ãƒ»è¡¨ç¾ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ãŸã‚‰è¨€ã„æ›ãˆã‚‹
  ï¼ˆç‰¹ã«åŒä¸€æ–‡å†…ã§åŒã˜è¨€è‘‰ãŒ2å›å‡ºãªã„ã‚ˆã†æ³¨æ„ï¼‰
ãƒ»æ™‚åˆ¶ã‚’çµ±ä¸€ã™ã‚‹
ãƒ»ã€Œã€œã¨ã„ã†å£°ãŒèã“ãˆã¦ãã‚‹ã¨ã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  åŒæ™‚ã«èµ·ããŸå‡ºæ¥äº‹ã‚’æ¡ä»¶æ–‡ï¼ˆã€œã¨ï¼‰ã§ã¤ãªãã®ã¯ä¸è‡ªç„¶ãªã®ã§ç¦æ­¢
  â†’ ã€Œã€œã¨ã„ã†å£°ã‚‚èã“ãˆã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  ã€€ ä¸¦åˆ—ï¼ˆã€œã‚‚èã“ãˆï¼‰ã§ã¤ãªãã“ã¨
ãƒ»æ–‡æœ«ã¯ã€Œã€œã—ãŸã€ã€Œã€œã—ã¦ã„ã‚‹ã€ã€Œã€œã‚‰ã‚ŒãŸã€ã‚’çŠ¶æ³ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹
ãƒ»ä¸€æ–‡ãŒ70æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰²ã™ã‚‹
ãƒ»åŠ©è©ï¼ˆã‚’ãƒ»ãŒãƒ»ã¯ãƒ»ã«ï¼‰ã®èª¤ç”¨ãŒãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»ä¸»èªã¨è¿°èªãŒã­ã˜ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»çµµæ–‡å­—ã¯ä½¿ç”¨ã—ãªã„
""",
    "ãã®ä»–": """
ã‚ãªãŸã¯æ—¥æœ¬èªãƒã‚¤ãƒ†ã‚£ãƒ–ã®ç·¨é›†è€…ã¨ã—ã¦ã€
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ä¸€å­—ä¸€å¥å®ˆã£ã¦æ·»å‰Šã—ã¦ãã ã•ã„ã€‚
ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã“ã¨ã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªã«ã™ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«ã—ã¦ãã ã•ã„ã€‚
æ·»å‰Šã¯2å›è¡Œã£ã¦ãã ã•ã„ã€‚
1å›ç›®ï¼šæ–‡æ³•ãƒ»è¡¨ç¾ã®ä¿®æ­£
2å›ç›®ï¼š1å›ç›®ã®çµæœã‚’èª­ã¿è¿”ã—ã€ä¸è‡ªç„¶ãªç®‡æ‰€ã‚’ã•ã‚‰ã«ä¿®æ­£
æœ€çµ‚çš„ã«2å›ç›®ã®çµæœã®ã¿ã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ã€‚

ã‚ãªãŸã¯æ—¥æœ¬èªæ–‡ç« ã®æ·»å‰Šãƒ»æ¨æ•²ã®å°‚é–€å®¶ã§ã™ã€‚
ã€æ·»å‰Šãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»èª­ã¿ã‚„ã™ãè‡ªç„¶ãªæ—¥æœ¬èªã«æ•´ãˆã‚‹
ãƒ»ã€Œã§ã—ã‚‡ã†ã€ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„
ãƒ»åŒã˜è¨€è‘‰ãƒ»è¡¨ç¾ãŒç¹°ã‚Šè¿”ã•ã‚Œã¦ã„ãŸã‚‰è¨€ã„æ›ãˆã‚‹
  ï¼ˆç‰¹ã«åŒä¸€æ–‡å†…ã§åŒã˜è¨€è‘‰ãŒ2å›å‡ºãªã„ã‚ˆã†æ³¨æ„ï¼‰
ãƒ»æ™‚åˆ¶ã‚’çµ±ä¸€ã™ã‚‹
ãƒ»ã€Œã€œã¨ã„ã†å£°ãŒèã“ãˆã¦ãã‚‹ã¨ã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  åŒæ™‚ã«èµ·ããŸå‡ºæ¥äº‹ã‚’æ¡ä»¶æ–‡ï¼ˆã€œã¨ï¼‰ã§ã¤ãªãã®ã¯ä¸è‡ªç„¶ãªã®ã§ç¦æ­¢
  â†’ ã€Œã€œã¨ã„ã†å£°ã‚‚èã“ãˆã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã®ã‚ˆã†ã«
  ã€€ ä¸¦åˆ—ï¼ˆã€œã‚‚èã“ãˆï¼‰ã§ã¤ãªãã“ã¨
ãƒ»ä¸€æ–‡ãŒ70æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰²ã™ã‚‹
ãƒ»åŠ©è©ï¼ˆã‚’ãƒ»ãŒãƒ»ã¯ãƒ»ã«ï¼‰ã®èª¤ç”¨ãŒãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»èª­ç‚¹ï¼ˆã€ï¼‰ã®ä½ç½®ãŒè‡ªç„¶ã‹ç¢ºèªã™ã‚‹
ãƒ»ä¸»èªã¨è¿°èªãŒã­ã˜ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã™ã‚‹
ãƒ»çµµæ–‡å­—ã¯ä½¿ç”¨ã—ãªã„
""",
}

TONE_INSTRUCTIONS = {
    "ä¸å¯§": "ã‚ˆã‚Šä¸å¯§ã§æ”¹ã¾ã£ãŸè¡¨ç¾ãƒ»æ•¬èªã«æ•´ãˆã¦ãã ã•ã„ã€‚",
    "ã‚„ã‚ã‚‰ã‹": "ã‚ˆã‚ŠæŸ”ã‚‰ã‹ãè¦ªã—ã¿ã‚„ã™ã„ã€æ¸©ã‚‚ã‚Šã®ã‚ã‚‹è¡¨ç¾ã«æ•´ãˆã¦ãã ã•ã„ã€‚",
    "ç°¡æ½”": "å†—é•·ãªè¡¨ç¾ã‚’çœãã€ç°¡æ½”ã§ã‚ã‹ã‚Šã‚„ã™ã„æ–‡ç« ã«æ•´ãˆã¦ãã ã•ã„ã€‚",
}

RESPONSE_SCHEMA = {
    "type": "json_schema",
    "json_schema": {
        "name": "proofread_result",
        "strict": True,
        "schema": {
            "type": "object",
            "properties": {
                "corrected_text": {"type": "string"},
            },
            "required": ["corrected_text"],
            "additionalProperties": False,
        },
    },
}

# â”€â”€â”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "history" not in st.session_state:
    st.session_state.history = []
if "current_result" not in st.session_state:
    st.session_state.current_result = None
if "edited_text" not in st.session_state:
    st.session_state.edited_text = ""
if "restore_index" not in st.session_state:
    st.session_state.restore_index = None

# â”€â”€â”€ OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_resource
def get_client():
    try:
        return OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
    except Exception:
        return None

client = get_client()

# â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def call_proofread_api(
    doc_type: str,
    text: str,
    context: str = "",
    tone: str | None = None,
) -> dict | None:
    """OpenAI APIã§æ·»å‰Šã‚’å®Ÿè¡Œã—ã¦JSONã‚’è¿”ã™ã€‚"""
    if client is None:
        st.error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`.streamlit/secrets.toml` ã« `OPENAI_API_KEY` ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚")
        return None

    system_prompt = DOC_SYSTEM_PROMPTS[doc_type]
    system_prompt += (
        "\n\nä¿®æ­£å¾Œã®æ–‡ç« ã®ã¿ã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ã€‚ä½™åˆ†ãªèª¬æ˜ã¯ä¸è¦ã§ã™ã€‚"
    )

    user_content = f"ã€æ–‡æ›¸ç¨®åˆ¥ã€‘{doc_type}\n"
    if context:
        user_content += f"ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‘{context}\n"
    if tone:
        user_content += f"ã€æ–‡ä½“èª¿æ•´ã€‘{TONE_INSTRUCTIONS[tone]}\n"
    user_content += f"\nã€æ·»å‰Šå¯¾è±¡ã®æ–‡ç« ã€‘\n{text}"
    user_content += (
        "\n\næ·»å‰Šå¾Œã€ä»¥ä¸‹ã‚’å¿…ãšãƒã‚§ãƒƒã‚¯ã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ï¼š\n"
        "ã€çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ãªã„ã“ã¨ã€‘\n"
        "ãƒ»ã€Œã§ã—ã‚‡ã†ã€ã‚’ä½¿ã†\n"
        "ãƒ»åŒä¸€æ–‡å†…ã§åŒã˜è¨€è‘‰ã‚’2å›ä½¿ã†ï¼ˆç‰¹ã«ã€Œå§¿ã€ã€Œå­ã©ã‚‚ãŸã¡ã€ã€Œæ§˜å­ã€ï¼‰\n"
        "ãƒ»æ™‚åˆ¶ãŒæ··åœ¨ã™ã‚‹ï¼ˆéå»å½¢ã§æ›¸ã„ã¦ã„ã‚‹ã®ã«é€”ä¸­ã ã‘ç¾åœ¨å½¢ã«ã™ã‚‹ï¼‰\n"
        "ãƒ»åŒæ™‚ã«èµ·ããŸå‡ºæ¥äº‹ã‚’ã€Œã€œã™ã‚‹ã¨ã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã¨æ¡ä»¶æ–‡ã§ã¤ãªã\n"
        "  â†’å¿…ãšã€Œã€œã—ã€ã€œã—ã¦ã„ã¾ã—ãŸã€ã¨ä¸¦åˆ—ã§ã¤ãªãã“ã¨\n"
        "ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ»SNSç³»ã®çµµæ–‡å­—ã‚’ä½¿ã†ï¼ˆğŸ—£ï¸ğŸ”¥ğŸ’¡ğŸ“Œâœ…ğŸ¯ã¯çµ¶å¯¾ç¦æ­¢ï¼‰\n"
        "ãƒ»ä¸€é€£ã®å‹•ä½œã®æµã‚Œã‚’ä¸è‡ªç„¶ã«åˆ†å‰²ã™ã‚‹\n"
        "ãƒ»å…ƒã®æ–‡ã®è‡¨å ´æ„Ÿãƒ»ãƒ†ãƒ³ãƒã‚’æãªã†\n"
        "ã€å¿…ãšã‚„ã‚‹ã“ã¨ã€‘\n"
        "ãƒ»å£°ã«å‡ºã—ã¦èª­ã‚“ã§ä¸è‡ªç„¶ãªç®‡æ‰€ãŒãªã„ã‹ç¢ºèªã™ã‚‹\n"
        "ãƒ»åŠ©è©ï¼ˆã‚’ãƒ»ãŒãƒ»ã¯ãƒ»ã«ï¼‰ã®èª¤ç”¨ã‚’ä¿®æ­£ã™ã‚‹\n"
        "ãƒ»èª­ç‚¹ï¼ˆã€ï¼‰ã®ä½ç½®ã‚’è‡ªç„¶ã«ã™ã‚‹\n"
        "ãƒ»ä¸»èªã¨è¿°èªã®ã­ã˜ã‚Œã‚’ç›´ã™\n"
        "ãƒ»æ–‡æœ«è¡¨ç¾ãŒå˜èª¿ã«ãªã‚‰ãªã„ã‚ˆã†ã€Œã€œã¾ã—ãŸã€ã€Œã€œã§ã™ã€ã€Œã€œã¦ã„ã¾ã™ã€ã‚’ä½¿ã„åˆ†ã‘ã‚‹\n"
        "ãƒ»å­ã©ã‚‚ã®è¨€è‘‰ã¯ã€Œã€ã§ãã®ã¾ã¾å¼•ç”¨ã—ã¦ç”Ÿã‹ã™\n"
        "ãƒ»å…ƒã®æ–‡ã‚ˆã‚Šä¸è‡ªç„¶ã«ãªã£ã¦ã„ãŸã‚‰å…ƒã®è¡¨ç¾ã‚’æ®‹ã™\n"
        "ä¸Šè¨˜ãƒã‚§ãƒƒã‚¯ã‚’å…¨ã¦å®Œäº†ã—ã¦ã‹ã‚‰æœ€çµ‚çš„ãªJSONã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"
    )

    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            max_tokens=4096,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_content},
            ],
            response_format=RESPONSE_SCHEMA,
        )
        raw = response.choices[0].message.content
        return json.loads(raw)
    except json.JSONDecodeError:
        st.error("AIã®å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")
        return None
    except OpenAIAuthError:
        st.error("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚`.streamlit/secrets.toml` ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return None
    except Exception as e:
        st.error(f"APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None


def save_to_history(doc_type: str, original: str, result: dict):
    entry = {
        "timestamp": datetime.now().strftime("%H:%M"),
        "doc_type": doc_type,
        "original": original,
        "corrected": result["corrected_text"],
    }
    st.session_state.history.insert(0, entry)
    if len(st.session_state.history) > 20:
        st.session_state.history.pop()


def render_result(original: str, result: dict):
    """æ·»å‰Šçµæœã‚¨ãƒªã‚¢ã‚’æç”»ã™ã‚‹ã€‚"""
    st.divider()
    st.subheader("æ·»å‰Šçµæœ")

    # ä¿®æ­£å¾Œãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
    st.markdown("**ä¿®æ­£å¾Œã®æ–‡ç« **")
    st.markdown(
        f'<div class="result-box">{result["corrected_text"]}</div>',
        unsafe_allow_html=True,
    )

    # ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
    corrected_json = json.dumps(result["corrected_text"])
    copy_html = f"""<button id="copyBtn" onclick="copyToClipboard()" style="padding:4px 12px;cursor:pointer;border:1px solid #ccc;border-radius:4px;background:#fff;">ã‚³ãƒ”ãƒ¼</button>
<span id="copyMsg" style="color:green;margin-left:8px;"></span>
<script>
function copyToClipboard() {{
    var text = {corrected_json};
    navigator.clipboard.writeText(text).then(function() {{
        document.getElementById('copyMsg').innerText = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        setTimeout(function() {{ document.getElementById('copyMsg').innerText = ''; }}, 2000);
    }}).catch(function() {{
        var ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        document.getElementById('copyMsg').innerText = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        setTimeout(function() {{ document.getElementById('copyMsg').innerText = ''; }}, 2000);
    }});
}}
</script>"""
    components.html(copy_html, height=50)

    # æ–‡ä½“èª¿æ•´ãƒœã‚¿ãƒ³
    st.markdown("**æ–‡ä½“ã‚’èª¿æ•´ã™ã‚‹**")
    tone_cols = st.columns(3)
    tones = list(TONE_INSTRUCTIONS.keys())
    for i, tone in enumerate(tones):
        with tone_cols[i]:
            if st.button(tone, key=f"tone_{tone}"):
                with st.spinner(f"ã€Œ{tone}ã€ã«èª¿æ•´ä¸­..."):
                    adjusted = call_proofread_api(
                        st.session_state.get("selected_doc_type", "ãã®ä»–"),
                        original,
                        st.session_state.get("context_input", ""),
                        tone=tone,
                    )
                if adjusted:
                    st.session_state.current_result = adjusted
                    st.session_state.tone_adjusted = True
                    save_to_history(
                        st.session_state.get("selected_doc_type", "ãã®ä»–"),
                        original,
                        adjusted,
                    )
                    st.rerun()


# â”€â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.header("è¨­å®š")

    doc_type = st.radio("æ–‡æ›¸ã®ç¨®é¡", DOC_TYPES, index=2)
    st.session_state.selected_doc_type = doc_type

    st.divider()

    st.header("æ·»å‰Šå±¥æ­´")
    if not st.session_state.history:
        st.caption("ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“")
    else:
        for idx, entry in enumerate(st.session_state.history):
            label = f"{entry['timestamp']} [{entry['doc_type']}] {entry['original'][:15]}..."
            if st.button(label, key=f"hist_{idx}", use_container_width=True):
                st.session_state.restore_index = idx
                st.rerun()

# â”€â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.title("ğŸ“ ä¿è‚²ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ æ·»å‰Šãƒ»æ¨æ•²ãƒ„ãƒ¼ãƒ«")
st.caption("é€£çµ¡å¸³ãƒ»ä¿è‚²æ—¥èªŒãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã®æ–‡ç« ã‚’AIãŒæ·»å‰Šãƒ»æ¨æ•²ã—ã¾ã™")

# å±¥æ­´å¾©å…ƒ
restore_text = ""
if st.session_state.restore_index is not None:
    idx = st.session_state.restore_index
    if 0 <= idx < len(st.session_state.history):
        entry = st.session_state.history[idx]
        restore_text = entry["original"]
        st.session_state.current_result = {
            "corrected_text": entry["corrected"],
        }
        st.session_state.edited_text = entry["corrected"]
    st.session_state.restore_index = None

input_text = st.text_area(
    "æ·»å‰Šã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
    value=restore_text,
    height=180,
    placeholder="ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",
    key="input_text_area",
)

char_count = len(input_text)
count_parts = [f"ç¾åœ¨ {char_count} æ–‡å­—"]
if st.session_state.current_result:
    corrected_count = len(st.session_state.current_result.get("corrected_text", ""))
    count_parts.append(f"ä¿®æ­£å¾Œ {corrected_count} æ–‡å­—")
st.caption("ã€€ã€€".join(count_parts))

col_btn, col_clear = st.columns([3, 1])
with col_btn:
    proofread_clicked = st.button("æ·»å‰Šã™ã‚‹", type="primary", use_container_width=True)
with col_clear:
    if st.button("ã‚¯ãƒªã‚¢", use_container_width=True):
        st.session_state.current_result = None
        st.session_state.edited_text = ""
        st.session_state.tone_adjusted = False
        st.rerun()

if proofread_clicked:
    if not input_text.strip():
        st.warning("æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        st.session_state.tone_adjusted = False
        with st.spinner("æ·»å‰Šä¸­..."):
            result = call_proofread_api(doc_type, input_text)
        if result:
            st.session_state.current_result = result
            st.session_state.edited_text = result["corrected_text"]
            save_to_history(doc_type, input_text, result)

if st.session_state.current_result:
    # å…ƒãƒ†ã‚­ã‚¹ãƒˆã®ç‰¹å®šï¼ˆå…¥åŠ›æ¬„ or å¾©å…ƒã•ã‚ŒãŸå±¥æ­´ï¼‰
    original = input_text or restore_text
    render_result(original, st.session_state.current_result)
